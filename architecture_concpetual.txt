ğŸ‘¤ User Input
(message, history, session_id)
    |
    V
ğŸš€ FastAPI `/chat` Endpoint
â†’ ğŸ§  Routes user query to main pipeline  
â†’ ğŸ§¹ Clears session if needed  
    |
    V
ğŸ”§ `run_preprocessing()`
â†’ ğŸ—ï¸ Loads and structures profile data and summary  
â†’ Ensures input grounding  
    |
    V
ğŸ§± `system_prompt(summary, profile_data)`
â†’ ğŸ§  Constructs the system-level prompt to guide LLM behavior  
â†’ Includes career, competencies, and summary  
    |
    V
ğŸ“š Build Message Stack
â†’ ğŸ§¾ Assembles `[system] + [history] + [user]`  
â†’ Prepares message list for LLM  
    |
    V
ğŸ§  `run_chat_completion(messages)`
â†’ ğŸ¯ Core function that calls OpenAI model  
â†’ Sends tool schemas (`tools`)  
â†’ Handles tool calls if LLM requests them  
    |
    â”œâ”€â”€ Tool Calls Triggered? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    |                                      |
    | âœ… Yes                               âŒ No
    |  |                                   |
    |  V                                   V
    | ğŸ› ï¸ `tool_dispatch` Lookup          ğŸ“ Use LLM Output as Response
    |     - `record_user_details()`        (no tool actions required)
    |     - `record_unknown_question()`    
    |     â†’ Sends to ğŸ“² `pushover.py`  
    |     â†’ Returns tool result (JSON string)  
    |     â†’ Appended back to message stack  
    |                                      |
    | <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Loop back to model â”€â”€â”€â”€â”˜
    |
    V
ğŸ§ª `evaluate_and_fix_response(...)`
â†’ ğŸ” Critiques the model's output with a checklist  
â†’ âª Regenerates if confidence is low or hallucination detected  
    |
    V
ğŸ’¡ `discovery_prompt_check(...)`
â†’ ğŸŒ± Adds proactive, relevant exploration prompts  
â†’ E.g. â€œYou might also want to exploreâ€¦â€  
    |
    V
ğŸ¯ `maybe_add_lead_followup(...)`
â†’ ğŸ§² Detects buying or interest signals  
â†’ Appends friendly follow-up CTA (call-to-action)  
    |
    V
ğŸ“ Final Response
â†’ âœ… Returned to frontend
â†’ ğŸ¯ Delivers structured, high-trust answer grounded in profile
